#!/bin/bash
# Ryx AI - Main executable
# Usage: ryx [command] [args]
#   ryx              - Start interactive CLI
#   ryx ryxhub       - Start RyxHub web interface
#   ryx status       - Show service status
#   ryx stop         - Stop RyxHub services (keeps vLLM)
#   ryx stop all     - Stop ALL services (keeps Docker images)
#   ryx cleanup      - Light cleanup (free RAM, keeps images)
#   ryx cleanup all  - Full cleanup (removes Docker images)

PROJECT_ROOT="/home/tobi/ryx-ai"
VLLM_CONTAINER="ryx-vllm"
SEARXNG_CONTAINER="ryx-searxng"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check if Docker is running, start if not
ensure_docker() {
    if docker info &>/dev/null; then
        return 0
    fi
    echo -e "${YELLOW}Starting Docker...${NC}"
    sudo systemctl start docker 2>/dev/null
    sleep 2
    if ! docker info &>/dev/null; then
        echo -e "${RED}Docker failed to start${NC}"
        exit 1
    fi
}

# Start vLLM via docker-compose (uses compose config for proper setup)
start_vllm() {
    if docker ps --format '{{.Names}}' | grep -q "^${VLLM_CONTAINER}$"; then
        if curl -s http://localhost:8001/v1/models &>/dev/null; then
            return 0
        fi
    fi
    
    echo -e "${YELLOW}Starting vLLM...${NC}"
    docker compose -f "$PROJECT_ROOT/docker/vllm/docker-compose.yml" up -d 2>/dev/null
    
    echo -n "Waiting for vLLM "
    local elapsed=0
    local max_wait=60
    while [ $elapsed -lt $max_wait ]; do
        if curl -s http://localhost:8001/v1/models &>/dev/null; then
            echo -e "\r${GREEN}✓${NC} vLLM ready (${elapsed}s)"
            return 0
        fi
        printf "\rWaiting for vLLM ${CYAN}[${elapsed}s]${NC}"
        sleep 2
        elapsed=$((elapsed + 2))
    done
    echo -e "\r${YELLOW}⚠${NC} vLLM starting in background (${max_wait}s)"
    return 0
}

# Start SearXNG container with proper config
start_searxng() {
    if docker ps --format '{{.Names}}' | grep -q "^${SEARXNG_CONTAINER}$"; then
        return 0
    fi
    
    echo -e "${YELLOW}Starting SearXNG...${NC}"
    cd "$PROJECT_ROOT/docker/searxng"
    docker compose up -d 2>/dev/null
    sleep 2
}

# Stop all Ryx services
stop_services() {
    echo -e "${YELLOW}Stopping Ryx services...${NC}"
    
    # Stop RyxHub processes
    [ -f "$PROJECT_ROOT/data/ryxhub_api.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_api.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_api.pid"
    [ -f "$PROJECT_ROOT/data/ryxhub_frontend.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_frontend.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_frontend.pid"
    
    # Kill any remaining processes on ports
    fuser -k 8420/tcp 2>/dev/null
    fuser -k 8080/tcp 2>/dev/null
    
    # Stop containers (but don't remove vLLM - takes too long to restart)
    docker stop "$SEARXNG_CONTAINER" 2>/dev/null
    echo -e "${GREEN}Stopped${NC}"
}

# Stop everything including vLLM (but keep containers/images intact)
stop_all() {
    echo -e "${RED}╔═══════════════════════════════════════╗${NC}"
    echo -e "${RED}║         STOPPING ALL SERVICES         ║${NC}"
    echo -e "${RED}╚═══════════════════════════════════════╝${NC}"
    
    # Stop RyxHub processes
    echo -e "${YELLOW}Stopping RyxHub processes...${NC}"
    [ -f "$PROJECT_ROOT/data/ryxhub_api.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_api.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_api.pid"
    [ -f "$PROJECT_ROOT/data/ryxhub_frontend.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_frontend.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_frontend.pid"
    fuser -k 8420/tcp 2>/dev/null
    fuser -k 8080/tcp 2>/dev/null
    
    # Kill any python/node processes from ryx
    pkill -f "uvicorn ryx_pkg" 2>/dev/null
    pkill -f "vite.*ryxhub" 2>/dev/null
    
    # Stop all ryx containers (but don't remove them)
    echo -e "${YELLOW}Stopping containers...${NC}"
    docker stop "$VLLM_CONTAINER" "$SEARXNG_CONTAINER" 2>/dev/null
    
    echo -e "${GREEN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║         ALL SERVICES STOPPED          ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════╝${NC}"
    echo -e "  Containers stopped (preserved for fast restart)"
    echo -e "  Docker images intact"
    echo -e "\n${CYAN}Run 'ryx' to restart services${NC}"
}

# Light cleanup - remove temporary stuff, free RAM (keeps images)
cleanup_light() {
    echo -e "${YELLOW}╔═══════════════════════════════════════╗${NC}"
    echo -e "${YELLOW}║         CLEANUP (Light)               ║${NC}"
    echo -e "${YELLOW}╚═══════════════════════════════════════╝${NC}"
    
    # Clean dangling images and build cache
    echo -e "${YELLOW}Cleaning Docker build cache...${NC}"
    docker system prune -f 2>/dev/null
    
    # Clean up any orphaned containers
    echo -e "${YELLOW}Removing stopped containers...${NC}"
    docker container prune -f 2>/dev/null
    
    # Drop filesystem caches to reclaim memory
    echo -e "${YELLOW}Freeing cached memory...${NC}"
    sudo sync 2>/dev/null
    sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches' 2>/dev/null
    
    # Clean Python cache
    echo -e "${YELLOW}Cleaning Python cache...${NC}"
    find "$PROJECT_ROOT" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null
    find "$PROJECT_ROOT" -type f -name "*.pyc" -delete 2>/dev/null
    
    echo -e "${GREEN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║         CLEANUP COMPLETE              ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════╝${NC}"
    echo -e "  Build cache cleared"
    echo -e "  Memory caches freed"
    echo -e "  Docker images preserved (fast restart)"
}

# Full cleanup - remove everything including Docker images (requires rebuild)
cleanup_all() {
    echo -e "${RED}╔═══════════════════════════════════════╗${NC}"
    echo -e "${RED}║       CLEANUP ALL (Full Reset)        ║${NC}"
    echo -e "${RED}╚═══════════════════════════════════════╝${NC}"
    echo -e "${RED}Warning: This will remove Docker images!${NC}"
    echo -e "${RED}Services will need to be rebuilt on next start.${NC}"
    echo ""
    
    # First stop everything
    echo -e "${YELLOW}Stopping all services...${NC}"
    [ -f "$PROJECT_ROOT/data/ryxhub_api.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_api.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_api.pid"
    [ -f "$PROJECT_ROOT/data/ryxhub_frontend.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_frontend.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_frontend.pid"
    fuser -k 8420/tcp 2>/dev/null
    fuser -k 8080/tcp 2>/dev/null
    pkill -f "uvicorn ryx_pkg" 2>/dev/null
    pkill -f "vite.*ryxhub" 2>/dev/null
    
    # Stop and REMOVE all ryx containers
    echo -e "${YELLOW}Stopping and removing containers...${NC}"
    docker stop "$VLLM_CONTAINER" "$SEARXNG_CONTAINER" 2>/dev/null
    docker rm -f "$VLLM_CONTAINER" "$SEARXNG_CONTAINER" 2>/dev/null
    
    # Remove ryx-related Docker images
    echo -e "${YELLOW}Removing Docker images...${NC}"
    docker rmi vllm/vllm-openai 2>/dev/null
    docker rmi searxng/searxng 2>/dev/null
    
    # Clean up Docker system completely
    echo -e "${YELLOW}Cleaning Docker system...${NC}"
    docker system prune -af 2>/dev/null
    docker volume prune -f 2>/dev/null
    
    # Drop filesystem caches to reclaim memory
    echo -e "${YELLOW}Freeing cached memory...${NC}"
    sudo sync 2>/dev/null
    sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches' 2>/dev/null
    
    # Clean Python cache
    echo -e "${YELLOW}Cleaning Python cache...${NC}"
    find "$PROJECT_ROOT" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null
    find "$PROJECT_ROOT" -type f -name "*.pyc" -delete 2>/dev/null
    
    echo -e "${GREEN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║       FULL CLEANUP COMPLETE           ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════╝${NC}"
    echo -e "  All containers removed"
    echo -e "  Docker images removed"
    echo -e "  Memory caches cleared"
    echo -e "\n${CYAN}Note: Run 'ryx' to restart (will re-pull images)${NC}"
}

# Full restart - stops everything including vLLM
full_restart() {
    local mode="${1:-general}"
    
    echo -e "${RED}╔═══════════════════════════════════════╗${NC}"
    echo -e "${RED}║     FULL RESTART - Stopping All       ║${NC}"
    echo -e "${RED}╚═══════════════════════════════════════╝${NC}"
    
    # Stop RyxHub
    echo -e "${YELLOW}Stopping RyxHub...${NC}"
    [ -f "$PROJECT_ROOT/data/ryxhub_api.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_api.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_api.pid"
    [ -f "$PROJECT_ROOT/data/ryxhub_frontend.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_frontend.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_frontend.pid"
    fuser -k 8420/tcp 2>/dev/null
    fuser -k 8080/tcp 2>/dev/null
    
    # Stop ALL ryx containers
    echo -e "${YELLOW}Stopping all containers...${NC}"
    docker stop "$VLLM_CONTAINER" "$SEARXNG_CONTAINER" 2>/dev/null
    docker rm "$VLLM_CONTAINER" "$SEARXNG_CONTAINER" 2>/dev/null
    
    # Kill any python/node processes from ryx
    pkill -f "uvicorn ryx_pkg" 2>/dev/null
    pkill -f "vite.*ryxhub" 2>/dev/null
    
    echo -e "${GREEN}All services stopped${NC}"
    sleep 2
    
    # Restart vLLM with specified mode
    echo -e "${CYAN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║     Starting with mode: ${mode}${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════╝${NC}"
    
    start_vllm_mode "$mode"
    start_searxng
    
    echo -e "\n${GREEN}Full restart complete!${NC}"
    echo -e "  Mode: ${CYAN}${mode}${NC}"
    echo -e "  Run ${CYAN}ryx${NC} to start CLI"
    echo -e "  Run ${CYAN}ryx ryxhub${NC} to start web UI"
}

# Start vLLM with specific mode (coding, general, fast)
start_vllm_mode() {
    local mode="${1:-general}"
    local compose_file="$PROJECT_ROOT/docker/vllm/modes/${mode}.yml"
    
    # Check if mode exists
    if [ ! -f "$compose_file" ]; then
        echo -e "${RED}Unknown mode: ${mode}${NC}"
        echo -e "Available modes: coding, general, fast"
        return 1
    fi
    
    # Stop existing vLLM
    docker stop "$VLLM_CONTAINER" 2>/dev/null
    docker rm "$VLLM_CONTAINER" 2>/dev/null
    
    echo -e "${YELLOW}Starting vLLM in ${mode} mode...${NC}"
    docker compose -f "$compose_file" up -d 2>/dev/null
    
    # Show mode info
    case "$mode" in
        coding)
            echo -e "  Model: ${CYAN}qwen2.5-coder-14b-awq${NC}"
            echo -e "  Context: ${CYAN}32K${NC} (FP8 KV cache)"
            ;;
        general)
            echo -e "  Model: ${CYAN}qwen2.5-14b-gptq${NC}"
            echo -e "  Context: ${CYAN}16K${NC}"
            ;;
        fast)
            echo -e "  Model: ${CYAN}qwen2.5-7b-awq${NC}"
            echo -e "  Context: ${CYAN}32K${NC}"
            ;;
    esac
    
    echo -n "Waiting for vLLM "
    local elapsed=0
    local max_wait=120  # Longer wait for model loading
    while [ $elapsed -lt $max_wait ]; do
        if curl -s http://localhost:8001/v1/models &>/dev/null; then
            echo -e "\r${GREEN}✓${NC} vLLM ready (${elapsed}s)"
            return 0
        fi
        printf "\rWaiting for vLLM ${CYAN}[${elapsed}s]${NC}"
        sleep 2
        elapsed=$((elapsed + 2))
    done
    echo -e "\r${YELLOW}⚠${NC} vLLM starting in background (${max_wait}s)"
    return 0
}

# Save current mode
save_mode() {
    local mode="$1"
    echo "$mode" > "$PROJECT_ROOT/data/.current_mode"
}

# Get current mode
get_current_mode() {
    if [ -f "$PROJECT_ROOT/data/.current_mode" ]; then
        cat "$PROJECT_ROOT/data/.current_mode"
    else
        echo "general"
    fi
}

# Show status
show_status() {
    echo -e "${CYAN}Ryx Services:${NC}"
    
    # Current mode
    current_mode=$(get_current_mode)
    echo -e "  Mode:       ${CYAN}${current_mode}${NC}"
    echo ""
    
    # vLLM
    if docker ps --format '{{.Names}}' | grep -q "^${VLLM_CONTAINER}$"; then
        if curl -s http://localhost:8001/v1/models &>/dev/null; then
            model_name=$(curl -s http://localhost:8001/v1/models | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4 | xargs basename 2>/dev/null || echo "unknown")
            echo -e "  vLLM:       ${GREEN}running${NC} (${model_name})"
        else
            echo -e "  vLLM:       ${YELLOW}starting${NC}"
        fi
    else
        echo -e "  vLLM:       ${RED}stopped${NC}"
    fi
    
    # SearXNG
    if docker ps --format '{{.Names}}' | grep -q "^${SEARXNG_CONTAINER}$"; then
        echo -e "  SearXNG:    ${GREEN}running${NC} (port 8888)"
    else
        echo -e "  SearXNG:    ${RED}stopped${NC}"
    fi
    
    # RyxHub API
    if curl -s http://localhost:8420/api/health &>/dev/null; then
        echo -e "  RyxHub API: ${GREEN}running${NC} (port 8420)"
    else
        echo -e "  RyxHub API: ${RED}stopped${NC}"
    fi
    
    # RyxHub Frontend
    if curl -s http://localhost:8080 &>/dev/null; then
        echo -e "  RyxHub Web: ${GREEN}running${NC} (port 8080)"
    else
        echo -e "  RyxHub Web: ${RED}stopped${NC}"
    fi
    
    echo ""
    echo -e "${CYAN}Available modes:${NC}"
    echo "  coding  - qwen2.5-coder-14b @ 32K (development)"
    echo "  general - qwen2.5-14b @ 16K (chat, docs)"
    echo "  fast    - qwen2.5-7b @ 32K (browser, quick)"
    echo ""
    echo -e "Switch: ${CYAN}ryx restart all for <mode>${NC}"
}

# Start RyxHub web interface
start_ryxhub() {
    echo -e "${CYAN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║         Starting RyxHub               ║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════╝${NC}"
    
    ensure_docker
    start_vllm
    start_searxng
    
    # Start API if not running
    if ! curl -s http://localhost:8420/api/health &>/dev/null; then
        echo -e "${YELLOW}Starting RyxHub API...${NC}"
        cd "$PROJECT_ROOT"
        [ -d "venv" ] && source venv/bin/activate
        
        VLLM_BASE_URL="http://localhost:8001" \
        SEARXNG_URL="http://localhost:8888" \
        SESSIONS_DIR="$PROJECT_ROOT/data/sessions" \
        nohup python -m uvicorn ryx_pkg.interfaces.web.backend.main:app \
            --host 0.0.0.0 --port 8420 \
            > "$PROJECT_ROOT/data/ryxhub_api.log" 2>&1 &
        echo $! > "$PROJECT_ROOT/data/ryxhub_api.pid"
        sleep 2
    fi
    
    # Start frontend if not running
    if ! curl -s http://localhost:8080 &>/dev/null; then
        echo -e "${YELLOW}Starting RyxHub Frontend...${NC}"
        cd "$PROJECT_ROOT/ryxhub"
        [ ! -d "node_modules" ] && npm install --silent
        
        VITE_RYX_API_URL="http://localhost:8420" \
        VITE_USE_MOCK_API="false" \
        nohup npm run dev -- --host 0.0.0.0 > "$PROJECT_ROOT/data/ryxhub_frontend.log" 2>&1 &
        echo $! > "$PROJECT_ROOT/data/ryxhub_frontend.pid"
        sleep 3
    fi
    
    echo -e "\n${GREEN}RyxHub ready: ${CYAN}http://localhost:8080${NC}"
    
    # Open browser
    xdg-open "http://localhost:8080" 2>/dev/null &
}

# Handle commands
case "$1" in
    surf|ryxsurf|browser)
        echo -e "${CYAN}╔═══════════════════════════════════════╗${NC}"
        echo -e "${CYAN}║         Starting RyxSurf              ║${NC}"
        echo -e "${CYAN}╚═══════════════════════════════════════╝${NC}"
        
        # Check if vLLM is running - don't restart if it's working
        if curl -s http://localhost:8001/v1/models &>/dev/null; then
            echo -e "${GREEN}✓${NC} vLLM already running"
        else
            # Start vLLM in fast mode only if not running
            echo -e "${YELLOW}Starting vLLM...${NC}"
            start_vllm_mode "fast"
        fi
        
        # Start browser immediately (AI features work when vLLM is ready)
        [ -d "$PROJECT_ROOT/venv" ] && source "$PROJECT_ROOT/venv/bin/activate"
        cd "$PROJECT_ROOT"
        exec python3 -m ryxsurf.main "$@"
        ;;
    ryxhub|hub|web)
        if [ "$2" = "restart" ]; then
            echo -e "${YELLOW}Restarting RyxHub (with full rebuild)...${NC}"
            stop_services

            # Force rebuild frontend
            echo -e "${CYAN}Rebuilding frontend...${NC}"
            cd "$PROJECT_ROOT/ryxhub"
            rm -rf .vite dist node_modules/.vite 2>/dev/null
            npm run build 2>&1 | grep -E "(built|error|warning)" || echo "Build complete"

            sleep 2
            start_ryxhub
        else
            start_ryxhub
        fi
        exit 0
        ;;
    stop)
        if [ "$2" = "all" ]; then
            stop_all
        else
            stop_services
        fi
        exit 0
        ;;
    status)
        show_status
        exit 0
        ;;
    cleanup)
        if [ "$2" = "all" ]; then
            cleanup_all
        else
            cleanup_light
        fi
        exit 0
        ;;
    restart)
        if [ "$2" = "ryxhub" ]; then
            echo -e "${YELLOW}Restarting RyxHub (with full rebuild)...${NC}"
            stop_services

            # Force rebuild frontend
            echo -e "${CYAN}Rebuilding frontend...${NC}"
            cd "$PROJECT_ROOT/ryxhub"
            rm -rf .vite dist node_modules/.vite 2>/dev/null
            npm run build 2>&1 | grep -E "(built|error|warning)" || echo "Build complete"

            sleep 2
            start_ryxhub
            exit 0
        elif [ "$2" = "all" ]; then
            # Check for "for <mode>" syntax
            if [ "$3" = "for" ] && [ -n "$4" ]; then
                mode="$4"
                # Map application names to modes
                case "$mode" in
                    ryxsurf|browser|surf)
                        mode="fast"
                        ;;
                    ryxhub|hub|web)
                        mode="general"
                        ;;
                    coding|code|dev)
                        mode="coding"
                        ;;
                    ryx|cli|general)
                        mode="general"
                        ;;
                esac
                save_mode "$mode"
                full_restart "$mode"
            else
                full_restart "$(get_current_mode)"
            fi
            exit 0
        else
            echo -e "${YELLOW}Usage:${NC}"
            echo "  ryx restart ryxhub           - Restart RyxHub with fresh build"
            echo "  ryx restart all              - Full restart with current mode"
            echo "  ryx restart all for coding   - Restart with coding model (32K context)"
            echo "  ryx restart all for general  - Restart with general model (16K context)"
            echo "  ryx restart all for fast     - Restart with fast model (7B, 32K context)"
            echo "  ryx restart all for ryxsurf  - Restart optimized for browser"
            exit 1
        fi
        ;;
    help|--help|-h)
        echo "Ryx AI - Terminal assistant"
        echo ""
        echo "Usage: ryx [command]"
        echo ""
        echo "Commands:"
        echo "  (none)           Start interactive CLI"
        echo "  ryxhub           Start RyxHub web interface"
        echo "  ryxhub restart   Restart RyxHub with fresh build"
        echo "  status           Show service status"
        echo "  stop             Stop RyxHub services (keeps vLLM running)"
        echo "  stop all         Stop ALL services including vLLM"
        echo "  cleanup          Light cleanup - free RAM, clear caches"
        echo "  cleanup all      Full cleanup - remove Docker images"
        echo ""
        echo "Mode Switching:"
        echo "  restart all              Restart with current mode"
        echo "  restart all for coding   32K context, qwen2.5-coder-14b (dev work)"
        echo "  restart all for general  16K context, qwen2.5-14b (chat, docs)"
        echo "  restart all for fast     32K context, qwen2.5-7b (browser, quick)"
        echo "  restart all for ryxsurf  Alias for 'fast' mode"
        echo ""
        echo "Current mode: $(get_current_mode)"
        exit 0
        ;;
esac

# Start base services for CLI
ensure_docker
start_vllm
start_searxng

# Activate venv and run CLI
[ -d "$PROJECT_ROOT/venv" ] && source "$PROJECT_ROOT/venv/bin/activate"
cd "$PROJECT_ROOT"
exec python3 ryx_main.py "$@"
