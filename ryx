#!/usr/bin/env python3
"""
Ryx AI - Main Entry Point
Production-grade local agentic CLI

Usage:
    ryx                     Start interactive session
    ryx "prompt"           One-shot query
    ryx --tier fast "..."  Use specific tier
    ryx --help             Show help
"""
import sys
import os
from pathlib import Path

# Auto-detect project root (resolve symlinks first, then get parent)
PROJECT_ROOT = Path(__file__).resolve().parent

# Add project to path
sys.path.insert(0, str(PROJECT_ROOT))

# Set environment variable for other modules to use
os.environ['RYX_PROJECT_ROOT'] = str(PROJECT_ROOT)


def main():
    args = sys.argv[1:]
    
    # Parse arguments
    tier_override = None
    prompt_args = []
    show_help = False
    legacy_mode = False
    
    i = 0
    while i < len(args):
        arg = args[i]
        
        if arg in ['--help', '-h']:
            show_help = True
        elif arg in ['--tier', '-t']:
            if i + 1 < len(args):
                tier_override = args[i + 1]
                i += 1
        elif arg.startswith('::'):
            # Legacy command mode for backward compatibility
            legacy_mode = True
            prompt_args = args[i:]
            break
        else:
            prompt_args.append(arg)
        
        i += 1
    
    # Show help
    if show_help:
        print_help()
        return
    
    # Legacy command mode
    if legacy_mode:
        from modes.cli_mode import handle_command
        cmd = prompt_args[0]
        cmd_args = prompt_args[1:] if len(prompt_args) > 1 else []
        handle_command(cmd, cmd_args)
        return
    
    # No arguments - start interactive session
    if not prompt_args:
        from core.session_loop import SessionLoop
        session = SessionLoop()
        if tier_override:
            session.router.set_tier(tier_override)
            session.current_tier = tier_override
        session.run()
        return
    
    # One-shot query
    prompt = " ".join(prompt_args)
    handle_oneshot(prompt, tier_override)


def handle_oneshot(prompt: str, tier: str = None):
    """Handle one-shot query"""
    from core.model_router_v2 import ModelRouter
    from core.intent_classifier import IntentClassifier, IntentType
    from core.workflow_orchestrator import WorkflowOrchestrator
    from core.ui import get_ui
    from core.rag_system import RAGSystem
    
    ui = get_ui()
    router = ModelRouter()
    classifier = IntentClassifier()
    rag = RAGSystem()
    
    # Set tier if specified
    if tier:
        router.set_tier(tier)
    
    # Handle instant greetings
    GREETINGS = {
        'hello': 'Hello! How can I help you today?',
        'hi': 'Hi there! What can I do for you?',
        'hey': 'Hey! Ready to help.',
        'howdy': 'Howdy! What do you need?',
        'sup': "What's up! Ask me anything.",
    }
    
    prompt_stripped = prompt.lower().strip().rstrip('!.,?')
    if prompt_stripped in GREETINGS:
        print(GREETINGS[prompt_stripped])
        return
    
    # Check cache
    cached = rag.query_cache(prompt)
    if cached:
        ui.print_cached()
        print(ui.format_response(cached))
        return
    
    # Classify intent
    intent = classifier.classify(prompt, router.ollama)
    
    # Handle tier override in prompt
    if intent.tier_override:
        router.set_tier(intent.tier_override)
        print(f"ðŸŸ£ Using {intent.tier_override} tier")
    
    # Show thinking
    ui.print_thinking()
    
    # For complex tasks, use workflow
    if intent.intent_type in [IntentType.CODE_EDIT, IntentType.CONFIG_EDIT, 
                              IntentType.SYSTEM_TASK] and intent.complexity >= 0.6:
        ui.clear_thinking()
        orchestrator = WorkflowOrchestrator(router)
        response = orchestrator.process_request(prompt)
        print(response)
    else:
        # Simple query
        use_tier = tier or router.get_tier_for_intent(intent.intent_type.value)
        result = router.query(prompt, tier=use_tier)
        
        ui.clear_thinking()
        
        if result.error:
            ui.print_error(result.error_message)
        else:
            print(ui.format_response(result.response))
            # Cache useful responses
            rag.cache_response(prompt, result.response, result.model_used)


def print_help():
    """Print help message"""
    help_text = """
\033[95mâ•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚  ðŸŸ£ ryx â€“ Local AI Agent                                   â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯\033[0m

\033[1mUsage:\033[0m
  ryx                       Start interactive session
  ryx "prompt"             One-shot query
  ryx --tier <name> "..."  Use specific model tier
  ryx --help               Show this help

\033[1mModel Tiers:\033[0m
  fast        Quick responses (mistral:7b)
  balanced    Default coding (qwen2.5-coder:14b)
  powerful    Complex tasks (deepseek-coder-v2:16b)
  ultra       Heavy reasoning (Qwen3-Coder:30B)
  uncensored  Personal chat (gpt-oss:20b)

\033[1mSession Commands:\033[0m
  /help       Show help
  /status     Show current status
  /tier       Switch model tier
  /clear      Clear history
  /quit       Exit session

\033[1mExamples:\033[0m
  ryx "refactor the intent parser"
  ryx --tier powerful "design a REST API"
  ryx "search web for vim plugins 2024"
  ryx  # Start interactive session

\033[2mJust type naturally - Ryx understands intent.\033[0m
"""
    print(help_text)


if __name__ == "__main__":
    main()
