#!/bin/bash
# Ryx AI - Main executable
# Backend: Ollama (localhost:11434)
#
# Usage: ryx [command] [args]
#   ryx              - Start interactive CLI
#   ryx ryxhub       - Start RyxHub web interface
#   ryx status       - Show service status
#   ryx stop         - Stop RyxHub services (keeps Ollama)
#   ryx stop all     - Stop ALL services
#   ryx cleanup      - Light cleanup (free RAM, keeps images)
#   ryx cleanup all  - Full cleanup (removes Docker images)

PROJECT_ROOT="/home/tobi/ryx-ai"
SEARXNG_CONTAINER="ryx-searxng"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check if Docker is running, start if not
ensure_docker() {
    if docker info &>/dev/null; then
        return 0
    fi
    echo -e "${YELLOW}Starting Docker...${NC}"
    sudo systemctl start docker 2>/dev/null
    sleep 2
    if ! docker info &>/dev/null; then
        echo -e "${RED}Docker failed to start${NC}"
        exit 1
    fi
}

# Start SearXNG container with proper config
start_searxng() {
    if docker ps --format '{{.Names}}' | grep -q "^${SEARXNG_CONTAINER}$"; then
        return 0
    fi
    
    echo -e "${YELLOW}Starting SearXNG...${NC}"
    cd "$PROJECT_ROOT/docker/searxng"
    docker compose up -d 2>/dev/null
    sleep 2
}

# Stop all Ryx services
stop_services() {
    echo -e "${YELLOW}Stopping Ryx services...${NC}"
    
    # Stop RyxHub processes
    [ -f "$PROJECT_ROOT/data/ryxhub_api.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_api.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_api.pid"
    [ -f "$PROJECT_ROOT/data/ryxhub_frontend.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_frontend.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_frontend.pid"
    
    # Kill any remaining processes on ports
    fuser -k 8420/tcp 2>/dev/null
    fuser -k 8080/tcp 2>/dev/null
    
    # Stop containers
    docker stop "$SEARXNG_CONTAINER" 2>/dev/null
    echo -e "${GREEN}Stopped${NC}"
}

# Stop everything including Ollama
stop_all() {
    echo -e "${RED}╔═══════════════════════════════════════╗${NC}"
    echo -e "${RED}║         STOPPING ALL SERVICES         ║${NC}"
    echo -e "${RED}╚═══════════════════════════════════════╝${NC}"
    
    # Stop RyxHub processes
    echo -e "${YELLOW}Stopping RyxHub processes...${NC}"
    [ -f "$PROJECT_ROOT/data/ryxhub_api.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_api.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_api.pid"
    [ -f "$PROJECT_ROOT/data/ryxhub_frontend.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_frontend.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_frontend.pid"
    fuser -k 8420/tcp 2>/dev/null
    fuser -k 8080/tcp 2>/dev/null
    
    # Kill any python/node processes from ryx
    pkill -f "uvicorn ryx_pkg" 2>/dev/null
    pkill -f "vite.*ryxhub" 2>/dev/null
    
    # Stop Ollama and unload all models
    echo -e "${YELLOW}Stopping Ollama...${NC}"
    # First unload all models (releases VRAM immediately)
    for model in $(curl -s http://localhost:11434/api/ps 2>/dev/null | python3 -c "import json,sys; [print(m['name']) for m in json.load(sys.stdin).get('models',[])]" 2>/dev/null); do
        curl -s -X POST http://localhost:11434/api/generate -d "{\"model\":\"$model\",\"keep_alive\":0}" > /dev/null 2>&1
    done
    # Then kill ollama process
    pkill -9 ollama 2>/dev/null
    
    # Stop all ryx containers (but don't remove them)
    echo -e "${YELLOW}Stopping containers...${NC}"
    docker stop "$SEARXNG_CONTAINER" 2>/dev/null
    
    echo -e "${GREEN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║         ALL SERVICES STOPPED          ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════╝${NC}"
    echo -e "  Ollama stopped (VRAM freed)"
    echo -e "  Containers stopped (preserved for fast restart)"
    echo -e "  Docker images intact"
    echo -e "\n${CYAN}Run 'ryx' to restart services${NC}"
}

# Light cleanup - remove temporary stuff, free RAM (keeps images)
cleanup_light() {
    echo -e "${YELLOW}╔═══════════════════════════════════════╗${NC}"
    echo -e "${YELLOW}║         CLEANUP (Light)               ║${NC}"
    echo -e "${YELLOW}╚═══════════════════════════════════════╝${NC}"
    
    # Clean dangling images and build cache
    echo -e "${YELLOW}Cleaning Docker build cache...${NC}"
    docker system prune -f 2>/dev/null
    
    # Clean up any orphaned containers
    echo -e "${YELLOW}Removing stopped containers...${NC}"
    docker container prune -f 2>/dev/null
    
    # Drop filesystem caches to reclaim memory
    echo -e "${YELLOW}Freeing cached memory...${NC}"
    sudo sync 2>/dev/null
    sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches' 2>/dev/null
    
    # Clean Python cache
    echo -e "${YELLOW}Cleaning Python cache...${NC}"
    find "$PROJECT_ROOT" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null
    find "$PROJECT_ROOT" -type f -name "*.pyc" -delete 2>/dev/null
    
    echo -e "${GREEN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║         CLEANUP COMPLETE              ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════╝${NC}"
    echo -e "  Build cache cleared"
    echo -e "  Memory caches freed"
    echo -e "  Docker images preserved (fast restart)"
}

# Full cleanup - remove everything including Docker images (requires rebuild)
cleanup_all() {
    echo -e "${RED}╔═══════════════════════════════════════╗${NC}"
    echo -e "${RED}║       CLEANUP ALL (Full Reset)        ║${NC}"
    echo -e "${RED}╚═══════════════════════════════════════╝${NC}"
    echo -e "${RED}Warning: This will remove Docker images!${NC}"
    echo -e "${RED}Services will need to be rebuilt on next start.${NC}"
    echo ""
    
    # First stop everything
    echo -e "${YELLOW}Stopping all services...${NC}"
    [ -f "$PROJECT_ROOT/data/ryxhub_api.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_api.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_api.pid"
    [ -f "$PROJECT_ROOT/data/ryxhub_frontend.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_frontend.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_frontend.pid"
    fuser -k 8420/tcp 2>/dev/null
    fuser -k 8080/tcp 2>/dev/null
    pkill -f "uvicorn ryx_pkg" 2>/dev/null
    pkill -f "vite.*ryxhub" 2>/dev/null
    
    # Stop and REMOVE all ryx containers
    echo -e "${YELLOW}Stopping and removing containers...${NC}"
    docker stop "$SEARXNG_CONTAINER" 2>/dev/null
    docker rm -f "$SEARXNG_CONTAINER" 2>/dev/null
    
    # Remove ryx-related Docker images
    echo -e "${YELLOW}Removing Docker images...${NC}"
    docker rmi searxng/searxng 2>/dev/null
    
    # Clean up Docker system completely
    echo -e "${YELLOW}Cleaning Docker system...${NC}"
    docker system prune -af 2>/dev/null
    docker volume prune -f 2>/dev/null
    
    # Drop filesystem caches to reclaim memory
    echo -e "${YELLOW}Freeing cached memory...${NC}"
    sudo sync 2>/dev/null
    sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches' 2>/dev/null
    
    # Clean Python cache
    echo -e "${YELLOW}Cleaning Python cache...${NC}"
    find "$PROJECT_ROOT" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null
    find "$PROJECT_ROOT" -type f -name "*.pyc" -delete 2>/dev/null
    
    echo -e "${GREEN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║       FULL CLEANUP COMPLETE           ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════╝${NC}"
    echo -e "  All containers removed"
    echo -e "  Docker images removed"
    echo -e "  Memory caches cleared"
    echo -e "\n${CYAN}Note: Run 'ryx' to restart (will re-pull images)${NC}"
}

# Full restart - stops everything including Ollama
full_restart() {
    echo -e "${RED}╔═══════════════════════════════════════╗${NC}"
    echo -e "${RED}║     FULL RESTART - Stopping All       ║${NC}"
    echo -e "${RED}╚═══════════════════════════════════════╝${NC}"
    
    # Detect what's currently running
    echo -e "${YELLOW}Detecting running services...${NC}"
    RYXHUB_WAS_RUNNING=false
    
    # Check if RyxHub is running
    if curl -s http://localhost:8420/api/health &>/dev/null || curl -s http://localhost:8080 &>/dev/null; then
        RYXHUB_WAS_RUNNING=true
        echo -e "  ${GREEN}✓${NC} RyxHub detected"
    fi
    
    # Stop RyxHub
    echo -e "${YELLOW}Stopping RyxHub...${NC}"
    [ -f "$PROJECT_ROOT/data/ryxhub_api.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_api.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_api.pid"
    [ -f "$PROJECT_ROOT/data/ryxhub_frontend.pid" ] && kill $(cat "$PROJECT_ROOT/data/ryxhub_frontend.pid") 2>/dev/null && rm "$PROJECT_ROOT/data/ryxhub_frontend.pid"
    fuser -k 8420/tcp 2>/dev/null
    fuser -k 8080/tcp 2>/dev/null
    
    # Stop ALL ryx containers
    echo -e "${YELLOW}Stopping all containers...${NC}"
    docker stop "$SEARXNG_CONTAINER" 2>/dev/null
    docker rm "$SEARXNG_CONTAINER" 2>/dev/null
    
    # Kill any python/node processes from ryx
    pkill -f "uvicorn ryx_pkg" 2>/dev/null
    pkill -f "vite.*ryxhub" 2>/dev/null
    
    echo -e "${GREEN}All services stopped${NC}"
    sleep 2
    
    # Restart services
    echo -e "${CYAN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║          Starting services             ║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════╝${NC}"
    
    start_searxng
    
    # Restart RyxHub if it was running
    if [ "$RYXHUB_WAS_RUNNING" = true ]; then
        echo -e "${YELLOW}Restarting RyxHub (was running before)...${NC}"
        start_ryxhub
    fi
    
    echo -e "\n${GREEN}Full restart complete!${NC}"
    if [ "$RYXHUB_WAS_RUNNING" = true ]; then
        echo -e "  ${GREEN}✓${NC} RyxHub restored"
    else
        echo -e "  Run ${CYAN}ryx ryxhub${NC} to start web UI"
    fi
    echo -e "  Run ${CYAN}ryx${NC} to start CLI"
}

# Remove old mode functions (no longer needed)
start_vllm_mode() { echo "vLLM mode removed - using Ollama"; }
save_mode() { :; }
get_current_mode() { echo "ollama"; }

# Show status
show_status() {
    echo -e "${CYAN}Ryx Services:${NC}"
    echo -e "  Backend:    ${CYAN}Ollama${NC}"
    echo ""
    
    # Ollama
    if curl -s http://localhost:11434/api/tags &>/dev/null; then
        echo -e "  Ollama:     ${GREEN}running${NC} (port 11434)"
    else
        echo -e "  Ollama:     ${RED}stopped${NC}"
    fi
    
    # SearXNG
    if docker ps --format '{{.Names}}' | grep -q "^${SEARXNG_CONTAINER}$"; then
        echo -e "  SearXNG:    ${GREEN}running${NC} (port 8888)"
    else
        echo -e "  SearXNG:    ${RED}stopped${NC}"
    fi
    
    # RyxHub API
    if curl -s http://localhost:8420/api/health &>/dev/null; then
        echo -e "  RyxHub API: ${GREEN}running${NC} (port 8420)"
    else
        echo -e "  RyxHub API: ${RED}stopped${NC}"
    fi
    
    # RyxHub Frontend
    if curl -s http://localhost:8080 &>/dev/null; then
        echo -e "  RyxHub Web: ${GREEN}running${NC} (port 8080)"
    else
        echo -e "  RyxHub Web: ${RED}stopped${NC}"
    fi
    
    echo ""
    echo -e "${CYAN}Available models:${NC}"
    if curl -s http://localhost:11434/api/tags &>/dev/null; then
        curl -s http://localhost:11434/api/tags | python3 -c "import json,sys; [print(f'  - {m[\"name\"]}') for m in json.load(sys.stdin).get('models',[])]" 2>/dev/null || echo "  (none)"
    else
        echo "  (Ollama not running)"
    fi
}

# Start RyxHub web interface
start_ryxhub() {
    echo -e "${CYAN}╔═══════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║         Starting RyxHub               ║${NC}"
    echo -e "${CYAN}╚═══════════════════════════════════════╝${NC}"
    
    ensure_docker
    start_searxng
    
    # Check Ollama is running
    if ! curl -s http://localhost:11434/api/tags &>/dev/null; then
        echo -e "${YELLOW}⚠️  Ollama not running. Start with: ollama serve${NC}"
        return 1
    fi
    
    # Load last used model or default
    LAST_MODEL_FILE="$PROJECT_ROOT/data/last_model"
    if [ -f "$LAST_MODEL_FILE" ]; then
        LOAD_MODEL=$(cat "$LAST_MODEL_FILE")
        echo -e "${YELLOW}Loading last used model: $LOAD_MODEL...${NC}"
    else
        LOAD_MODEL="qwen2.5:1.5b"
        echo -e "${YELLOW}Loading default model: $LOAD_MODEL...${NC}"
    fi
    curl -s http://localhost:11434/api/generate -d "{\"model\":\"$LOAD_MODEL\",\"prompt\":\"\"}" > /dev/null
    
    # Start API if not running
    if ! curl -s http://localhost:8420/api/health &>/dev/null; then
        echo -e "${YELLOW}Starting RyxHub API...${NC}"
        cd "$PROJECT_ROOT"
        [ -d "venv" ] && source venv/bin/activate
        
        OLLAMA_BASE_URL="http://localhost:11434" \
        SEARXNG_URL="http://localhost:8888" \
        SESSIONS_DIR="$PROJECT_ROOT/data/sessions" \
        nohup python -m uvicorn ryx_pkg.interfaces.web.backend.main:app \
            --host 0.0.0.0 --port 8420 \
            > "$PROJECT_ROOT/data/ryxhub_api.log" 2>&1 &
        echo $! > "$PROJECT_ROOT/data/ryxhub_api.pid"
        sleep 3
    fi
    
    # Start frontend if not running
    if ! curl -s http://localhost:8080 &>/dev/null; then
        echo -e "${YELLOW}Starting RyxHub Frontend...${NC}"
        cd "$PROJECT_ROOT/ryxhub"
        [ ! -d "node_modules" ] && npm install --silent
        
        VITE_RYX_API_URL="http://localhost:8420" \
        VITE_USE_MOCK_API="false" \
        nohup npm run dev -- --host 0.0.0.0 > "$PROJECT_ROOT/data/ryxhub_frontend.log" 2>&1 &
        echo $! > "$PROJECT_ROOT/data/ryxhub_frontend.pid"
        sleep 3
    fi
    
    echo -e "\n${GREEN}RyxHub ready: ${CYAN}http://localhost:8080${NC}"
    echo -e "${GREEN}✓${NC} Ollama backend: $LOAD_MODEL"
    echo -e "${GREEN}✓${NC} SearXNG search enabled"
    
    # Open browser
    xdg-open "http://localhost:8080" 2>/dev/null &
}

# Handle commands
case "$1" in
    surf|ryxsurf|browser)
        # Launch Python RyxSurf (uses GTK/WebKit)
        cd "$PROJECT_ROOT/ryxsurf"
        [ -d "$PROJECT_ROOT/venv" ] && source "$PROJECT_ROOT/venv/bin/activate"
        exec python main.py "${@:2}"
        ;;
    ryxhub|hub|web)
        if [ "$2" = "restart" ]; then
            echo -e "${YELLOW}Restarting RyxHub (with full rebuild)...${NC}"
            stop_services

            # Force rebuild frontend
            echo -e "${CYAN}Rebuilding frontend...${NC}"
            cd "$PROJECT_ROOT/ryxhub"
            rm -rf .vite dist node_modules/.vite 2>/dev/null
            npm run build 2>&1 | grep -E "(built|error|warning)" || echo "Build complete"

            sleep 2
            start_ryxhub
        else
            start_ryxhub
        fi
        exit 0
        ;;
    stop)
        if [ "$2" = "all" ]; then
            stop_all
        else
            stop_services
        fi
        exit 0
        ;;
    status)
        show_status
        exit 0
        ;;
    cleanup)
        if [ "$2" = "all" ]; then
            cleanup_all
        else
            cleanup_light
        fi
        exit 0
        ;;
    restart)
        if [ "$2" = "ryxhub" ]; then
            echo -e "${YELLOW}Restarting RyxHub (with full rebuild)...${NC}"
            stop_services

            # Force rebuild frontend
            echo -e "${CYAN}Rebuilding frontend...${NC}"
            cd "$PROJECT_ROOT/ryxhub"
            rm -rf .vite dist node_modules/.vite 2>/dev/null
            npm run build 2>&1 | grep -E "(built|error|warning)" || echo "Build complete"

            sleep 2
            start_ryxhub
            exit 0
        elif [ "$2" = "all" ]; then
            full_restart
            exit 0
        else
            echo -e "${YELLOW}Usage:${NC}"
            echo "  ryx restart ryxhub   - Restart RyxHub with fresh build"
            echo "  ryx restart all      - Full restart (Ollama + SearXNG + RyxHub)"
            exit 1
        fi
        ;;
    help|--help|-h)
        echo "Ryx AI - Terminal assistant"
        echo ""
        echo "Usage: ryx [command]"
        echo ""
        echo "Commands:"
        echo "  (none)           Start interactive CLI"
        echo "  ryxhub           Start RyxHub web interface"
        echo "  ryxhub restart   Restart RyxHub with fresh build"
        echo "  status           Show service status"
        echo "  stop             Stop RyxHub services (keeps Ollama running)"
        echo "  stop all         Stop ALL services including Ollama"
        echo "  restart all      Full restart of all services"
        echo "  cleanup          Light cleanup - free RAM, clear caches"
        echo "  cleanup all      Full cleanup - remove Docker images"
        echo "  self-improve     Run autonomous self-improvement cycle"
        echo "  benchmark        Run self-benchmark"
        echo ""
        echo "Backend: Ollama (localhost:11434)"
        exit 0
        ;;
    self-improve|selfimprove|improve)
        echo -e "${CYAN}╔═══════════════════════════════════════╗${NC}"
        echo -e "${CYAN}║    Ryx Autonomous Self-Improvement    ║${NC}"
        echo -e "${CYAN}╚═══════════════════════════════════════╝${NC}"
        
        # Check Ollama is running
        if ! curl -s http://localhost:11434/api/tags &>/dev/null; then
            echo -e "${YELLOW}Starting Ollama...${NC}"
            "$PROJECT_ROOT/scripts/start_ollama.sh" &
            sleep 5
        fi
        
        [ -d "$PROJECT_ROOT/venv" ] && source "$PROJECT_ROOT/venv/bin/activate"
        cd "$PROJECT_ROOT"
        
        # Pass remaining args (--auto, --cycles N)
        shift
        exec python3 core/self_improver.py "$@"
        ;;
    benchmark|bench)
        echo -e "${CYAN}Running Ryx Benchmark...${NC}"
        
        # Check Ollama is running
        if ! curl -s http://localhost:11434/api/tags &>/dev/null; then
            echo -e "${YELLOW}Starting Ollama...${NC}"
            "$PROJECT_ROOT/scripts/start_ollama.sh" &
            sleep 5
        fi
        
        [ -d "$PROJECT_ROOT/venv" ] && source "$PROJECT_ROOT/venv/bin/activate"
        cd "$PROJECT_ROOT"
        exec python3 scripts/benchmark.py
        ;;
esac

# Start base services for CLI
ensure_docker
# Check Ollama
if ! curl -s http://localhost:11434/api/tags &>/dev/null; then
    echo -e "${YELLOW}⚠️  Ollama not running${NC}"
    echo -e "Start with: ${CYAN}ollama serve${NC}"
    exit 1
fi
# SearXNG is started on-demand by Python when web search is needed
# Don't start it for every CLI command (saves resources)

# Activate venv and run CLI
[ -d "$PROJECT_ROOT/venv" ] && source "$PROJECT_ROOT/venv/bin/activate"
cd "$PROJECT_ROOT"
exec python3 ryx_main.py "$@"
