From 737a7e6b534113627f0ab617034b56df1cf63c7e Mon Sep 17 00:00:00 2001
From: Tobito320 <ahmedhdplay12345@gmail.com>
Date: Thu, 11 Dec 2025 20:00:17 +0100
Subject: [PATCH 14/14] docs: Add bugfixes documentation

---
 ryxsurf-cpp/BUGFIXES.md | 106 ++++++++++++++++++++++++++++++++++++++++
 1 file changed, 106 insertions(+)
 create mode 100644 ryxsurf-cpp/BUGFIXES.md

diff --git a/ryxsurf-cpp/BUGFIXES.md b/ryxsurf-cpp/BUGFIXES.md
new file mode 100644
index 0000000..1c66095
--- /dev/null
+++ b/ryxsurf-cpp/BUGFIXES.md
@@ -0,0 +1,106 @@
+# Security & Correctness Bug Fixes
+
+## Fixed Bugs
+
+### Bug 1: Null Pointer Dereference in `getenv("HOME")`
+
+**Location**: 
+- `src/snapshot_manager.cpp:18`
+- `src/persistence_manager.cpp:35`
+- `src/password_manager.cpp:47`
+
+**Issue**: 
+`std::getenv("HOME")` was called without null checking. If `HOME` environment variable is unset, this returns `nullptr`, causing undefined behavior when passed to `std::filesystem::path`.
+
+**Fix**:
+```cpp
+const char* home = std::getenv("HOME");
+if (!home) {
+    // Fallback to /tmp if HOME is not set
+    base_dir = std::filesystem::path("/tmp") / "ryxsurf";
+} else {
+    base_dir = std::filesystem::path(home) / ".local" / "share" / "ryxsurf";
+}
+```
+
+**Impact**: Prevents crashes when HOME is unset (rare but possible in containers/chroot).
+
+---
+
+### Bug 2: SQL Injection Vulnerabilities
+
+**Location**: 
+- `src/persistence_manager.cpp:228-275` (save_workspace)
+- `src/persistence_manager.cpp:345-362` (load_all)
+
+**Issue**: 
+SQL queries were constructed by directly concatenating user-controlled strings (workspace names, session names, URLs, titles) without proper escaping. An attacker-controlled workspace/session name or URL containing SQL metacharacters could inject arbitrary SQL code.
+
+**Example vulnerable code**:
+```cpp
+ss << "VALUES ('" << workspace->get_name() << "', ...);";
+execute_sql(ss.str());  // SQL injection possible!
+```
+
+**Fix**:
+Replaced all string concatenation with parameterized queries using `sqlite3_prepare_v2()` and `sqlite3_bind_*()`:
+
+```cpp
+const char* sql = "INSERT OR REPLACE INTO workspaces (name, created_at, updated_at) VALUES (?, ?, ?);";
+sqlite3_stmt* stmt;
+sqlite3_prepare_v2(db_, sql, -1, &stmt, nullptr);
+sqlite3_bind_text(stmt, 1, workspace->get_name().c_str(), -1, SQLITE_STATIC);
+sqlite3_bind_int64(stmt, 2, created);
+sqlite3_bind_int64(stmt, 3, updated);
+sqlite3_step(stmt);
+sqlite3_finalize(stmt);
+```
+
+**Impact**: Prevents SQL injection attacks. All user-controlled data is now properly escaped.
+
+**Affected Queries**:
+- Workspace insertion/update
+- Session insertion/update
+- Tab insertion
+- Session loading (WHERE workspace_id = ?)
+- Tab loading (WHERE session_id = ?)
+
+---
+
+### Bug 3: Incorrect Clock Type for Persistence
+
+**Location**: 
+- `src/persistence_manager.cpp:269` (save_workspace)
+- `include/tab.h:43` (get_last_active return type)
+
+**Issue**: 
+`Tab::get_last_active()` returns `steady_clock::time_point`, but `steady_clock` measures elapsed time, not absolute time. Its epoch is undefined and implementation-specific. Calling `time_since_epoch()` on `steady_clock` produces meaningless timestamps that cannot be reliably restored.
+
+**Fix**:
+1. Added `Tab::get_last_active_system()` returning `system_clock::time_point` for persistence
+2. Tab now tracks both:
+   - `steady_clock::time_point last_active_` - For relative timing (unload checks)
+   - `system_clock::time_point last_active_system_` - For absolute timestamps (persistence)
+3. `mark_active()` updates both clocks
+4. Persistence uses `get_last_active_system()` instead of `get_last_active()`
+
+**Impact**: Timestamps can now be reliably stored and restored. Unload timeout calculations still use `steady_clock` for accurate relative time measurements.
+
+---
+
+## Security Improvements
+
+1. ✅ All SQL queries use parameterized statements
+2. ✅ Proper null handling for environment variables
+3. ✅ Correct timestamp handling for persistence
+4. ✅ No user-controlled data in SQL strings
+
+## Testing Recommendations
+
+1. Test with `HOME` unset: `HOME="" ./build/ryxsurf`
+2. Test SQL injection attempts: Create workspace with name `"'; DROP TABLE workspaces; --"`
+3. Test timestamp persistence: Save session, restart browser, verify timestamps restored correctly
+
+## Commit
+
+Fixed in commit: `879a5c9` - "fix: security and correctness bugs"
-- 
2.52.0

